<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time Object Detection with Roboflow</title>
    <script src="https://cdn.roboflow.com/0.2.26/roboflow.js"></script>
    <style>
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        #container {
            position: relative;
        }
    </style>
</head>
<body>
    <h1>Real-Time Object Detection</h1>
    <div id="container">
        <video id="webcam" autoplay playsinline width="640" height="480"></video>
        <canvas id="canvas" width="640" height="480"></canvas>
    </div>
    <p id="status">Loading...</p>

    <script>
        // Access the webcam
        async function setupWebcam() {
            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ video: {
                facingMode: 'environment',
            } });
            video.srcObject = stream;

            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        // Initialize and return the canvas context
        function initCanvas() {
            const canvas = document.getElementById('canvas');
            return canvas.getContext('2d');
        }

        // Draw detections on the canvas
        function drawDetections(context, predictions) {
            predictions.forEach(prediction => {
                const { x, y, width, height, class: className, confidence } = prediction;
                // Draw the bounding box
                context.strokeStyle = '#00FF00';
                context.lineWidth = 4;
                context.strokeRect(x, y, width, height);

                // Draw the label background
                context.fillStyle = '#00FF00';
                context.fillRect(x, y, context.measureText(className + ' ' + confidence.toFixed(2)).width, 16);

                // Draw the text
                context.fillStyle = '#000000';
                context.fillText(className + ' ' + confidence.toFixed(2), x, y + 12);
            });
        }

        // Run inference on the video stream
        async function runInferenceOnStream(video) {
            try {
                const model = await initModel();
                const context = initCanvas();

                video.addEventListener('play', function() {
                    const timer = setInterval(async () => {
                        if (video.paused || video.ended) {
                            clearInterval(timer);
                            return;
                        }

                        // Run detection
                        model.detect(video).then(function(predictions) {
                            // Clear previous drawings
                            context.clearRect(0, 0, canvas.width, canvas.height);
                            console.log("Predictions:", predictions);
                            drawDetections(context, predictions);
                        });

                    }, 1000 / 30); // Run this every 30 frames
                });
            } catch (error) {
                console.error("Error during inference:", error);
            }
        }

        // Access the webcam
        async function setupWebcam() {
            const video = document.getElementById('webcam');
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;

            return new Promise((resolve) => {
                video.onloadedmetadata = () => {
                    resolve(video);
                };
            });
        }

        // Initialize the model
        async function initModel() {
    try {
        const model = await roboflow.auth({
            publishable_key: "rf_lcCX2E2cOfM8taGEpBZaH8oHUum2"
        }).load({
            model: "paintingdetection",
            version: 12 // Replace with your model version
        });

        // Log the model details
        console.log("Model loaded successfully:", model.getMetadata()

);

        document.getElementById('status').innerText = 'Model loaded successfully';
        return model;
    } catch (error) {
        document.getElementById('status').innerText = 'Error loading model: ' + error;
        throw error;
    }
}

        async function main() {
            try {
                const video = await setupWebcam();
                runInferenceOnStream(video);
            } catch (error) {
                console.error("Error setting up the app:", error);
            }
        }

        main();
    </script>
</body>
</html>
